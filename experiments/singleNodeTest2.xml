<?xml version="1.0"?>
<!DOCTYPE tsung SYSTEM "/opt/local/share/tsung/tsung-1.0.dtd">
<tsung loglevel="notice" version="1.0">

  <clients>
    <client host="localhost" use_controller_vm="true" maxusers="50000"></client>
  </clients>

  <!-- Server side setup -->
 <servers>
  <server host="129.215.197.207" port="5222" type="tcp"></server>

 </servers>

  <load>
   <arrivalphase phase="1" duration="1" unit="minute">
   <users maxnumber="2000" interarrival="0.1" unit="second"></users>
   </arrivalphase>
  </load>

  <!-- JABBER parameters -->
  <!-- to synchronise users,  use a global acknoledgement -->
 <options>
  <option type="ts_jabber" name="global_number" value="2000"></option>
  <option type="ts_jabber" name="userid_max" value="2000"></option>
  <option type="ts_jabber" name="domain" value="okbook.inf.ed.ac.uk"></option>
  <option type="ts_jabber" name="username" value="user"></option>
  <option type="ts_jabber" name="passwd" value="user"></option>
 </options>

  <sessions>

  <!-- ************************************ Session standard avec messages diriges vers les utilisateurs en ligne ******************************** -->

   <session probability="0" name="jabber-test-connexions" type="ts_jabber">

    <request> <jabber type="connect" ack="no_ack"></jabber> </request>
    <thinktime value="2"></thinktime>
    <transaction name="authenticate">
      <request> <jabber type="auth_get" ack="local"></jabber> </request>
      <request> <jabber type="auth_set_plain" ack="local"></jabber> </request>
    </transaction>

    <request> <jabber type="presence:initial" ack="no_ack"/> </request>
    <thinktime value="600"></thinktime>

  <transaction name="presence_directed">
    <request> <jabber type="presence:directed" show="away" status="Be right back..." ack="no_ack"/> </request>
    <request> <jabber type="presence:directed" show="chat" status="Available to chat" ack="no_ack"/> </request>
    <request> <jabber type="presence:directed" show="dnd" status="Don't bother me!" ack="no_ack"/> </request>
    <request> <jabber type="presence:directed" show="xa" status="I may never come back..." ack="no_ack"/> </request>
    <request> <jabber type="presence:directed" ack="no_ack"/> </request>
  </transaction>

    <transaction name="roster">
      <request> <jabber type="iq:roster:get" ack="local"></jabber> </request>
    </transaction>
    <thinktime value="10"></thinktime>

    <transaction name="online">
      <request> <jabber type="chat" ack="no_ack" size="16" destination="online"></jabber> </request>
    </transaction>
    <thinktime value="10"></thinktime>

    <transaction name="offline">
      <request> <jabber type="chat" ack="no_ack" size="56" destination="offline"></jabber> </request>
    </transaction>
    <thinktime value="10"></thinktime>

    <transaction name="close">
      <request> <jabber type="close" ack="no_ack"></jabber> </request>
    </transaction>

  </session>

  <!-- ************************************ Session avec creation de roster et messages diffuses vers les utilisateurs du roster ******************************** -->

  <session bidi="true" probability="0" name="jabber-test-rosters" type="ts_jabber">
    
   <request> <jabber type="connect" ack="local"></jabber> </request>
   <transaction name="authenticate">
     <request> <jabber type="auth_get" ack="local"></jabber> </request>
     <request> <jabber type="auth_set_plain" ack="local"></jabber> </request>
   </transaction>
   
   <thinktime value="2"></thinktime>
   
   <request> <jabber type="iq:roster:get" ack="local"/> </request>
 
  <thinktime value="2"></thinktime>

  <request> <jabber type="presence:initial" ack="no_ack"/> </request>
  
  <thinktime value="10"></thinktime>
    
  <!-- add five online users in the roster -->
  <transaction name="roster_add">
    <request> <jabber type="iq:roster:add" ack="no_ack" destination="online"></jabber> </request>
    <request> <jabber type="presence:subscribe" ack="no_ack"/> </request>
    
    <request> <jabber type="iq:roster:add" ack="no_ack" destination="online"></jabber> </request>
    <request> <jabber type="presence:subscribe" ack="no_ack"/> </request>
    
    <request> <jabber type="iq:roster:add" ack="no_ack" destination="online"></jabber> </request>
    <request> <jabber type="presence:subscribe" ack="no_ack"/> </request>
    
    <request> <jabber type="iq:roster:add" ack="no_ack" destination="online"></jabber> </request>
    <request> <jabber type="presence:subscribe" ack="no_ack"/> </request>
    
    <request> <jabber type="iq:roster:add" ack="no_ack" destination="online"></jabber> </request>
    <request> <jabber type="presence:subscribe" ack="no_ack"/> </request>
  </transaction>
  
   <!-- wait a long time  to let others session to add me in their roster-->
   <thinktime value="600"></thinktime>
 
  <!-- Broadcasts to members of it's own roster -->
  <transaction name="presence_brodcasts">
     <request> <jabber type="presence:broadcast" show="away" status="Be right back..." ack="no_ack"/> </request>
     <request> <jabber type="presence:broadcast" show="chat" status="Available to chat" ack="no_ack"/> </request>
     <request> <jabber type="presence:broadcast" show="dnd" status="Don't bother me!" ack="no_ack"/> </request>
     <request> <jabber type="presence:broadcast" show="xa" status="I may never come back..." ack="no_ack"/> </request>
     <request> <jabber type="presence:broadcast" ack="no_ack"/> </request>
     <request> <jabber type="presence:final" ack="no_ack"/> </request>
  </transaction>

   <thinktime value="1"></thinktime>
   <!-- Close roster -->
  <transaction name="roster_close">
    <request> <jabber type="close" ack="local"></jabber> </request>
  </transaction>
 
 </session>

  <!-- ************************************ Session avec authentification texte clair ******************************** -->

  <session probability="100" name="jabber-plain" type="ts_jabber">

    <request> <jabber type="connect" ack="no_ack"></jabber> </request>

    <thinktime value="2"></thinktime> 

    <transaction name="auth_plain">
      <request> <jabber type="auth_get" ack="local"></jabber> </request>
      <request> <jabber type="auth_set_plain" ack="local"></jabber> </request>
    </transaction>

    <thinktime value="600"></thinktime>

    <transaction name="close">
      <request> <jabber type="close" ack="no_ack"></jabber> </request>
    </transaction>

  </session>

<!-- ************************************ Session avec authentification digest ******************************** -->

  <session probability="0" name="jabber-digest" type="ts_jabber">

    <!-- regexp captures stream ID returned by server -->
    <request>
      <dyn_variable name="sid" regexp="&lt;stream:stream id=&quot;\(.*\)&quot; xmlns:stream"/>
      <jabber type="connect" ack="local"></jabber>
    </request>

    <thinktime value="2"></thinktime>

    <transaction name="auth_digest">
      <request> <jabber type="auth_get" ack="local"></jabber> </request>
      <request subst='true'> <jabber type="auth_set_digest" ack="local"></jabber> </request>
    </transaction>
    <thinktime value="600"></thinktime>

    <transaction name="close">
      <request> <jabber type="close" ack="no_ack"></jabber> </request>
    </transaction>
  </session>

<!-- ************************************ Session avec authentification sipdigest ******************************** -->

  <session probability="0" name="jabber-sipdigest" type="ts_jabber">

    <request> <jabber type="connect" ack="no_ack"></jabber> </request>

    <thinktime value="2"></thinktime>

    <transaction name="auth_sipdigest">
      <!-- regexp captures nonce value returned by server -->
      <request>
        <dyn_variable name="nonce" regexp="&lt;Nonce encoding=&quot;hex&quot;&gt;\(.*\)&lt;\/Nonce&gt;"/>
        <jabber type="auth_get" ack="local"></jabber>
      </request>
      <request subst='true'> <jabber type="auth_set_sip" ack="local"></jabber> </request>
    </transaction>
    <thinktime value="600"></thinktime>

    <transaction name="close">
      <request> <jabber type="close" ack="no_ack"></jabber> </request>
    </transaction>
  </session>

 </sessions>
</tsung>

